---
title: "SenateBEAT"
output: 
  flexdashboard::flex_dashboard:
    data-orientation: rows
runtime: shiny
---

```{r setup, include=FALSE}
# Libraries
library(treemap)
library(highcharter)
library(DT)
library(networkD3)
library(heatmaply)
library(tidyverse)
library(flexdashboard)
library(viridisLite)
library(shiny)
library(xml2)
library(grDevices)
library(distances)
library(gridExtra)
library(ggplot2)
library(reshape2)
library(wordcloud2)
library(readxl)
# Theme to use for highcharts (from example htmlwidgets page)
thm <- 
  hc_theme(
    colors = c("#1a6ecc", "#434348", "#90ed7d"),
    chart = list(
      backgroundColor = "white",
      style = list(fontFamily = "Source Sans Pro")
    ),
    xAxis = list(
      gridLineWidth = 1
    )
  )

red <- "rgba(205, 77, 77, 0.7)"
green <- "rgba(77, 205, 77, 0.7)"
blue <- "rgba(77, 77, 205, 0.7)"
###############################
### Data read in/processing ###
###############################
# Senator nodes
nodes <- read.csv("./data/nodes_proc.csv") %>% 
  mutate(label = paste0(last_name, ", ", first_name, " (", party, "-", state, ")"))
# Cosponsorship edges
simp_edges <- read.csv("./data/simplified_edges.csv")
# For heatmap
subject_matrix <- nodes %>%
  select(bioguideId, label, party, in_113, in_114, in_115) %>%
  left_join(read_csv("./data/member_leg_subject_matrix.csv"))
# Bill data for maps etc
mapdata3 <- read_csv("./data/mapdata3.csv")
# For individual Senator page
senatordata <- mapdata3
senatordata$senator <- paste(senatordata$first_name,senatordata$last_name,sep=" ")
senatordata$image <- paste("https://www.congress.gov/img/member/", tolower(senatordata$bioguideId), ".jpg", sep="")
# List for dropdown on map page
policy_area_list <- mapdata3 %>% 
  arrange(policy_area) %>% 
  .$policy_area %>% 
  unique()
# Processing map data for map page
mapdata3 <- mapdata3 %>%
  group_by(session, state_name, state, policy_area) %>%
  summarise(total_submit = sum(n()))

#For the modeling Data
fittedprob=read_csv("data/fittedprob.csv")
stack<-read_excel("data/stack.xlsx")
```

Home {.storyboard}
====================================
### Welcome to SenateBEAT

#### Introduction, blah blah blah 

Video

*** 

Commentary

### Another thing to look at

Wow this is cool!

***

Commentary about how cool it is

### Let's see another

Nice

*** 

I get the idea

### Last one for now

Great

***

Bye

Bill Modeling and Exploration{data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------
### General Inputs

```{r}
radioButtons(inputId = "session6",
            label = "Select legislative session",
            choices = c("All"="*",
                        "113th Session" = "113",
                        "114th Session" = "114",
                        "115th Session" = "115"),
            selected = "*")

```

### Model Inputs

```{r}
radioButtons(inputId = "category",
            label = "By Topic or By State",
            choices = c("By Topic" = 5,
                        "By State" = 7),
            selected = 7)

radioButtons(inputId = "methods",
            label = "Select Method",
            choices = c("Ordinary Logistic Regression" = 1,
                        "Lasso Logistic Regreesion" = 2,
                        "Ridge Logistics Regression" = 3),
            selected = 3)
```

### Cloud Inputs
```{r}
radioButtons(inputId = "party5",
            label = "Select Party",
            choices = c("Republican" = "R",
                        "Democratic" = "D",
                        "Independent"="I"),
            selected = "D")
```

Row {data-height=400}
-------------------------------------
### Fitted Probability

```{r}
probdata <- reactive({
fittedprob=fittedprob[,c(1:3,4,6,as.integer(input$category))]
colnames(fittedprob)[6]="x_axis"
fittedprob=fittedprob[,c(as.integer(input$methods),4:6)]
colnames(fittedprob)[1]="y_axis"
fittedprob=as.data.frame(fittedprob)
fittedprob%>%filter(grepl(input$session6, session))})

renderPlot({ggplot(probdata(),aes(x=x_axis,y=y_axis,color=factor(party)))+
  geom_point(alpha=0.5,size=1)+theme(axis.text.x = element_text(angle = 90, hjust = 1))+labs(y="Fitted Probability of Bills Become to Law")+scale_color_discrete(name="Senator's Party",position="bottom")})
#+facet_grid(session~.)
```

Row {data-height=300}
-------------------------------------
### Process of Bills
1. Introduced into Senate
  2. Ordered Reported
  3. Failed legislation; or received a vote, but failed in the senate
  4. Passed in the Senate 
  5. Passed in the House, but Vetoed by the President
  6. Became a law
```{r}
colnames(stack)=c("Topic","Introduced into Senate","Reported","Failed in the Senate","Passed in the Senate","Passed in the House","Become a Law")
temp=melt(stack,id="Topic")
p=ggplot(temp, aes(variable, value,group=Topic,color=Topic,fill=Topic))+geom_area(position = "stack")+theme(legend.position = "none")
ggplotly(p)
```

Row {data-height=300}
-------------------------------------
### Word Cloud
```{r}
subject<- nodes %>%
  select(bioguideId, party,state, in_113, in_114, in_115) %>%
  left_join(read_csv("./data/member_leg_subject_matrix.csv"))
words <- reactive({
  word_matrix=subject %>% filter(grepl(input$party5, party))
  freq=as.data.frame(colSums(word_matrix[7:1020]))
  word=row.names(freq)
  word_matrix=cbind(word,freq)
  rownames(word_matrix)=NULL
  colnames(word_matrix)[2]="freq"
  cloud_color="white"
  if(as.character(input$party5)=="R")
  {
    cloud_color="darksalmon"
  }
  else if(as.character(input$party5)=="D")
  {
    cloud_color="lightblue"
  }
  else if(as.character(input$party5)=="I")
  {
    cloud_color="lightgreen"
  }
  wordcloud2(data=word_matrix,size=0.7,backgroundColor=cloud_color)
  })

renderWordcloud2({words()})
```

### Bills Prediction

Under development

Thousands of bills are sponsored and introduced into the Senate during each legislative session. 

There are many final statuses of a bill, but we will only focus on the main 6 here. They include:

  1. Introduced into Senate
  2. Ordered Reported
  3. Failed legislation; or received a vote, but failed in the senate
  4. Passed in the Senate 
  5. Passed in the House, but Vetoed by the President
  6. Became a law
  
Explore below to see how many bills get to each step of the process, and which types of bills tend to be those most likely to become a law.

  (need to add) Define: Policy Area or Legislative Subject, in contract

(Additionally) Which legislative subjects do most of the Senate bills focus on? Explore the types of policy areas that are most prevalently introduced as bills. 


Bills Submitted {data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------
### Inputs

```{r input_objects}
radioButtons(inputId = "session",
            label = "Select legislative session",
            choices = c("All"="*",
                        "113th Session" = "113",
                        "114th Session" = "114",
                        "115th Session" = "115"),
            selected = "*")

selectInput(inputId = "policyarea",
           label = "Select Bill Policy Area",
           choices = c("All"="*", policy_area_list),
           selected = "Public Lands and Natural Resources")
```
<br><br>

### Policy area input

```{r}
selectInput(inputId = "state", 
            label = "Select a state", 
            choices = c("All" = "*", state.name),
            selected = "New Mexico",
            selectize = FALSE)
```


Row {data-height=600}
-------------------------------------
### Map

```{r}
data("usgeojson")

data_map <- reactive({
  mapdata3 %>%
    filter(grepl(input$session, session)) %>%
    filter(grepl(input$policyarea, policy_area)) 
  })

n <- 4
colstops <- data.frame(
  q = (0 : n) / n,
  c = substring(rev(viridis(n + 1)), 0, 7)) %>%
  list.parse2()

renderHighchart({
  dat <- data_map() %>%
    group_by(state_name) %>%
    summarise(total_submit = sum(total_submit))
  
  highchart() %>%
  hc_add_series_map(map = usgeojson, dat, name = "Bills submitted",
                    value = "total_submit", joinBy = c("woename", "state_name"),
                    dataLabels = list(enabled = TRUE,
                                      format = '{point.properties.postalcode}')) %>%
  hc_colorAxis(stops = colstops) %>%
  hc_legend(valueDecimals = 0) %>%
  hc_title(text = paste0(ifelse(input$policyarea == "*", "All", input$policyarea), " bills")) %>%
  hc_mapNavigation(enabled = TRUE) %>%
  hc_add_theme(thm)
})
```

Row {data-height=400}
-------------------------------------
### Policy Area by State

```{r}
data_areas <- reactive({
  # Get national totals
  national_totals <- mapdata3 %>% 
    group_by(policy_area, session) %>% 
    summarise(national_total = sum(total_submit)) %>% 
    ungroup()
  
  mapdata3 %>%
    left_join(national_totals) %>%
    filter(grepl(input$session, session)) %>%
    filter(grepl(input$state, state_name))
  })


renderHighchart({
  tm <- treemap(data_areas(), "policy_area",
                vSize = "total_submit", vColor = "national_total",
                type = "value", palette = rev(viridis(6)))

  hctreemap(tm) %>%
    hc_add_theme(thm) %>%
    hc_legend(align = "center", enabled = TRUE)
})
```

Senator Activity {data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

### Select a legislative session and a state to get a close-up of each senator's focus areas. 

```{r}
### Inputs
radioButtons(inputId = "session3",
            label = "Select legislative session",
            choices = c("All"="*",
                        "113th Session" = "113",
                        "114th Session" = "114",
                        "115th Session" = "115"),
            selected = "113")

```


```{r}
#state Input
selectInput(inputId = "state3", 
            label = "Select a state", 
            choices = c("All" = "*", state.name),
            selected = "Alaska",
            selectize = FALSE)
```

Row {data-height=300}
-------------------------------------
### Senator Spotlight: Alaska (D)

The Senators from Alaska sponsor more bills than any other state. Looking more closely at Senator ___, who worked in the 113th and 114th session, However, as seen above, the top focus areas are 1) 2) and 3) and. Yet, the percentage of success for getting these bills passed is almost zero. Yadda Yadda Yadda. 

Row {data-width=600, data-height=400}
-------------------------------------
### Senator summary statistics 

```{r}
senatorstats <- reactive({
  senatordata %>% 
    filter(grepl(input$session3, session)) %>% 
    group_by(state, senator) %>% 
    filter(grepl(input$state3, state_name))
  })


renderTable({ 
  senatorstats() %>%
  summarise(sum(n()), 
           sum(billoutcome == "Became Law"), 
           Percent = mean(billoutcome == "Became Law")*100) %>%
  `colnames<-`(c("State", "Senator", "Bills Introduced", "Number Passed as Law", "% Passed as Law"))
  })
    

```


Column {data-height=700}
-------------------------------------

### Senator picture
```{r}
# ^^^ TEMPORARILY SET eval=FALSE ABOVE ^^^
#senator picture code here
#photo <- reactive({
 # senatordata %>% 
  #  filter(grepl(input$session3, session)) %>% 
   # group_by(state, senator) %>% 
  #  filter(grepl(input$state3, state_name)) %>% select(senator, image)
#  })

#renderText({ 
  
#   photo() %>% unique(photo())  %>%
 # group_by(senator) 
  
#  senatordata %>% 
 #   filter(grepl(input$session3, session)) %>% 
  #  group_by(state, senator) %>% 
   # filter(grepl(input$state3, state_name)) %>%
    # c('<img src="',
     #  "image",
      # '">')

photo <-
  senatordata %>% 
    filter(session == "113") %>% 
    group_by(state, senator) %>% 
    filter(state_name == "Alaska") %>% select(image)


photo2 <- unique(photo)
photo3 <- photo2$image
  
photo2$image <- paste0("<a href='",photo2$image,"'>",photo2$image,"</a>")

#  })
  renderUI({

#for (i in photo3){
#src = i
 # print(paste(tag = tags$img(src=src)))
   
src = 'https://www.congress.gov/img/member/m001153.jpg'
tags$img(src=src)

  })

```


### Senator Network Data

```{r}

network <- reactive({
  senatordata %>% 
    filter(grepl(input$session3, session)) %>% 
    group_by(state, senator) %>% 
    filter(grepl(input$state3, state_name))
  })

renderForceNetwork({ 
  # sen_ID0 <- senatorstats() 
  # test <- senatordata %>% filter(grepl(input$session3, session))
  # sen_ID <- test %>% filter(grepl(input$state3, state_name))
  # sen_ID <- unique(as.character(sen_ID$bioguideId))
  sen_ID <- network()$bioguideId
  
  senator_edges <- simp_edges %>% 
    filter((from == sen_ID | to == sen_ID))
  
  senator_edges <- senator_edges[order(senator_edges$weight,decreasing = TRUE)[1:20],]
  # Then subset nodes
  nodes_subset <- nodes %>%
    filter((bioguideId %in% senator_edges$to | bioguideId %in% senator_edges$from))
  
  # Set target and source as indices to node data
  # minus 1 because it converts to JS which uses 0-indexing
  senator_edges <- senator_edges %>%
    mutate(source = match(from, nodes_subset$bioguideId) - 1,
           target = match(to, nodes_subset$bioguideId) - 1)
          
  forceNetwork(Links = senator_edges, Nodes = nodes_subset,
       Source = "source", Target = "target",
       Value = "weight", NodeID = "label", Group = "party",
  
       # -- Nodes and labels
       fontSize = 15,
       fontFamily = "sans-serif",
       opacity = 0.6,
       opacityNoHover = 0.5,
  
       # -- Edges
       arrows = TRUE,
       linkColour = c("grey", "grey"),
  
       # -- Layout
       linkDistance = 100,
       charge = -30,
  
       # -- General params
       colourScale = JS('d3.scaleOrdinal().range(["green", "blue", "red"]).domain(function(d) { (d.party); });'),
       zoom = TRUE,
       bounded = TRUE
       )     
 })

```

### Senator picture 2
```{r}
renderUI({

#for (i in photo3){
#src = i
 # print(paste(tag = tags$img(src=src)))
   
src = 'https://www.congress.gov/img/member/b001265.jpg'
tags$img(src=src)

  })


```




Row {data-height=700}
-------------------------------------
### Top Policy Areas

```{r}
toppolicy <- reactive({
  senatordata %>% 
    filter(grepl(input$session3, session)) %>% 
          group_by(state,senator,policy_area) %>% filter(grepl(input$state3, state_name)) %>% 
          mutate(numspon = sum(n())) %>% select(state, senator, policy_area, numspon)
  })

renderTable({ 

test2  <-  toppolicy()
test2 <- unique(test2)  %>%
  group_by(senator) %>% filter(numspon > 1) %>%
  top_n(n = 5, wt = numspon) %>% 'colnames<-'(c("State", "Senator", "Policy Area", "Number Sponsored"))
  test2
 })

```

Senate Overview {data-orientation=columns}
=====================================

Input {.sidebar}
-------------------------------------

```{r}
radioButtons(inputId = "session2",
            label = "Select legislative session",
            choices = c("All"="*",
                        "113th Session" = "113",
                        "114th Session" = "114",
                        "115th Session" = "115"),
            selected = "115")

checkboxGroupInput(inputId = "party",
            label = "Select party",
            choices = c("Republican" = "R",
                        "Democratic" = "D",
                        "Independent" = "I"),
            selected = c("R", "D", "I"))

# Dynamic list for dropdown
output$choose_senator <- renderUI({
  sen_list <- nodes %>%
    filter(party %in% input$party)
  if (input$session2 == "113") {
    sen_list <- sen_list %>% filter(in_113 == 1)
  } else if (input$session2 == "114") {
    sen_list <- sen_list %>% filter(in_114 == 1)
  } else if (input$session2 == "115") {
    sen_list <- sen_list %>% filter(in_115 == 1)
  } 
  selectInput(inputId = "matrix_senator",
            label = "Sort by Senator",
            choices = sort(sen_list$label),
            selected = NULL)
})

uiOutput(outputId = "choose_senator")

numericInput(inputId = "matrix_rows",
             label = "Number of Senators to display",
             value = 30, min = 10, max = 100, step = 1)

numericInput(inputId = "matrix_cols",
             label = "Number of legislative subjects to display",
             value = 30, min = 10, max = 60, step = 1)

numericInput(inputId = "matrix_page",
             label = "Select heatmap page", value = 1,
             min = 1, max = 21, step = 1)
```

Column {data-width=700}
-------------------------------------

### Legislative Subject Interests 

```{r}
data_heatmap <- reactive({
  # Matrix filtering
  filtered <- subject_matrix %>%
    filter(party %in% input$party)

  if (input$session2 == "113") {
    filtered <- filtered %>% filter(in_113 == 1)
  } else if (input$session2 == "114") {
    filtered <- filtered %>% filter(in_114 == 1)
  } else if (input$session2 == "115") {
    filtered <- filtered %>% filter(in_115 == 1)
  }
  
  mat <- filtered %>% 
    select(-bioguideId, -label, -party, -in_113, -in_114, -in_115)
  rownames(mat) <- filtered$label
  
  # Compute distances
  dists <- distances(mat)
  
  # Output options
  n <- input$matrix_page
  rows <- min(nrow(mat), input$matrix_rows)
  columns <- input$matrix_cols
  
  # Matrix sorting
  sortby <- mat[input$matrix_senator, ]
  mat <- mat[, order(sortby, decreasing = TRUE)]
  mat <- mat[nearest_neighbor_search(dists, rows, which(rownames(mat) == input$matrix_senator)), ]
  
  # To display
  mat[1:rows, (columns * (n - 1) + 1):(columns * n)]
})

renderPlotly({
  heatmaply(
    data_heatmap(),
    dendrogram = "none",
    label_names = c("Senator", "Subject", "Bills"),
    grid_gap = 0.3,
    hide_colorbar = TRUE
    )
})
```

Column {.tabset data-width=300}
-------------------------------------

### Bills Submitted

```{r}
senate_stats <- reactive({
  senatordata <- senatordata %>% 
      filter(grepl(input$session2, session)) %>% 
      group_by(bioguideId) %>%
      summarise(Introduced = sum(n()), Passed = sum(billoutcome == "Became Law"))
  
  dat <- nodes %>% left_join(senatordata)
})

n_rows <- reactive({
  input$matrix_rows
})

renderHighchart({
  dat <- senate_stats()
  dat <- dat[order(dat$Introduced, decreasing = TRUE), ] %>%
    mutate(color = ifelse(party == "R", red, ifelse(party == "D", blue, green))) %>%
    head(n = n_rows()) %>%
    select(label, Introduced, color)
  
  highchart() %>%
    hc_chart(type = "bar") %>%
    hc_xAxis(categories = dat$label) %>%
    hc_add_series_labels_values(labels = dat$label, 
                                values = dat$Introduced, 
                                colors = dat$color,
                                showInLegend = FALSE, 
                                name = "Bills submitted") %>%
    hc_add_theme(thm)
})

```

### Bills Passed

```{r}
renderHighchart({
  dat <- senate_stats()
  thresh <- nrow(filter(dat, Passed > 0 ))
  
  dat <- dat[order(dat$Passed, decreasing = TRUE), ] %>%
    mutate(color = ifelse(party == "R", red, ifelse(party == "D", blue, green))) %>%
    head(n = min(thresh, n_rows())) %>%
    select(label, Passed, color)
  
  highchart() %>%
    hc_chart(type = "bar") %>%
    hc_xAxis(categories = dat$label) %>%
    hc_add_series_labels_values(labels = dat$label, 
                                values = dat$Passed, 
                                colors = dat$color,
                                showInLegend = FALSE, 
                                name = "Bills passed") %>%
    hc_add_theme(thm)
})

```

### Bipartisan Index

```{r}
renderHighchart({
  
  
  dat <- senate_stats() %>%
    mutate(bipart_index = (total_in_nonparty + total_out_nonparty) / (total_in + total_out)) %>%
    mutate(color = ifelse(party == "R", red, ifelse(party == "D", blue, green)))
  
  dat <- dat[order(dat$bipart_index, decreasing = TRUE), ] %>%
    head(n = n_rows()) %>%
    select(label, bipart_index, color)


  highchart() %>%
    hc_chart(type = "bar") %>%
    hc_xAxis(categories = dat$label) %>%
    hc_add_series_labels_values(labels = dat$label, 
                                values = round(dat$bipart_index, 2), 
                                colors = dat$color,
                                showInLegend = FALSE, 
                                name = "Sponsorship network bipartisan index") %>%
    hc_add_theme(thm)
  
})

```



