---
title: "SenateBEAT"
output: 
  flexdashboard::flex_dashboard:
    data-orientation: rows
runtime: shiny
---

```{r setup, include=FALSE}
# Libraries
library(treemap)
library(highcharter)
library(DT)
library(networkD3)
library(heatmaply)
library(tidyverse)
library(flexdashboard)
library(viridisLite)
library(shiny)
library(xml2)
library(grDevices)
library(distances)
library(gridExtra)
library(ggplot2)

# Theme to use for highcharts (from example htmlwidgets page)
thm <- 
  hc_theme(
    colors = c("#1a6ecc", "#434348", "#90ed7d"),
    chart = list(
      backgroundColor = "white",
      style = list(fontFamily = "Source Sans Pro")
    ),
    xAxis = list(
      gridLineWidth = 1
    )
  )
###############################
### Data read in/processing ###
###############################
# Senator nodes
nodes <- read.csv("./data/nodes_proc.csv") %>% 
  mutate(label = paste0(last_name, ", ", first_name, " (", party, "-", state, ")"))
# Cosponsorship edges
simp_edges <- read.csv("./data/simplified_edges.csv")
# For heatmap
subject_matrix <- nodes %>%
  select(bioguideId, label, party, in_113, in_114, in_115) %>%
  left_join(read_csv("./data/member_leg_subject_matrix.csv"))
# Bill data for maps etc
mapdata3 <- read_csv("./data/mapdata3.csv")
# For individual Senator page
senatordata <- mapdata3
senatordata$senator <- paste(senatordata$first_name,senatordata$last_name,sep=" ")
senatordata$image <- paste("https://www.congress.gov/img/member/", tolower(senatordata$bioguideId), ".jpg", sep="")
# List for dropdown on map page
policy_area_list <- mapdata3 %>% 
  arrange(policy_area) %>% 
  .$policy_area %>% 
  unique()
# Processing map data for map page
mapdata3 <- mapdata3 %>%
  group_by(session, state_name, state, policy_area) %>%
  summarise(total_submit = sum(n()))
```

Home
====================================
### Welcome to SenateBEAT

#### Introduction, blah blah blah 

### Another thing to look at

Wow this is cool!

### Let's see another

Nice

### Last one for now

Great


Bills Submitted {data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------
### Inputs

```{r input_objects}
radioButtons(inputId = "session",
            label = "Select legislative session",
            choices = c("All"="*",
                        "113th Session" = "113",
                        "114th Session" = "114",
                        "115th Session" = "115"),
            selected = "*")

selectInput(inputId = "policyarea",
           label = "Select Bill Policy Area",
           choices = c("All"="*", policy_area_list))
```
<br><br>

### Policy area input

```{r}
selectInput(inputId = "state", 
            label = "Select a state", 
            choices = c("All" = "*", state.name),
            selectize = FALSE)
```


Row {data-height=600}
-------------------------------------
### Map

```{r}
data("usgeojson")

data_map <- reactive({
  mapdata3 %>%
    filter(grepl(input$session, session)) %>%
    filter(grepl(input$policyarea, policy_area)) 
  })

n <- 4
colstops <- data.frame(
  q = (0 : n) / n,
  c = substring(rev(viridis(n + 1)), 0, 7)) %>%
  list.parse2()

renderHighchart({
  dat <- data_map() %>%
    group_by(state_name) %>%
    summarise(total_submit = sum(total_submit))
  
  highchart() %>%
  hc_add_series_map(map = usgeojson, dat, name = "Bills submitted",
                    value = "total_submit", joinBy = c("woename", "state_name"),
                    dataLabels = list(enabled = TRUE,
                                      format = '{point.properties.postalcode}')) %>%
  hc_colorAxis(stops = colstops) %>%
  hc_legend(valueDecimals = 0) %>%
  hc_title(text = paste0(ifelse(input$policyarea == "*", "All", input$policyarea), " bills")) %>%
  hc_mapNavigation(enabled = TRUE) %>%
  hc_add_theme(thm)
})
```

Row {data-height=400}
-------------------------------------
### Policy Area

```{r}
data_areas <- reactive({
  # Get national totals
  national_totals <- mapdata3 %>% 
    group_by(policy_area, session) %>% 
    summarise(national_total = sum(total_submit)) %>% 
    ungroup()
  
  mapdata3 %>%
    left_join(national_totals) %>%
    filter(grepl(input$session, session)) %>%
    filter(grepl(input$state, state_name))
  })


renderHighchart({
  tm <- treemap(data_areas(), "policy_area",
                vSize = "total_submit", vColor = "national_total",
                type = "value", palette = rev(viridis(6)))
  # highchart() %>% 
  #   hc_add_series_treemap(tm, layoutAlgorithm = "squarified") %>% 
  #   hc_add_theme(thm)
  hctreemap(tm) %>%
    hc_add_theme(thm) %>%
    hc_legend(align = "center", enabled = TRUE)
})
```




Senate Overview {data-orientation=columns}
=====================================

Input {.sidebar}
-------------------------------------

```{r}
radioButtons(inputId = "session2",
            label = "Select legislative session",
            choices = c("All"="*",
                        "113th Session" = "113",
                        "114th Session" = "114",
                        "115th Session" = "115"),
            selected = "115")

checkboxGroupInput(inputId = "party",
            label = "Select party",
            choices = c("Republican" = "R",
                        "Democratic" = "D",
                        "Independent" = "I"),
            selected = c("R", "D", "I"))

uiOutput(outputId = "choose_senator")

numericInput(inputId = "matrix_rows",
             label = "Number of Senators \n(heatmap display)",
             value = 50, min = 10, max = 100, step = 1)

numericInput(inputId = "matrix_page",
             label = "Select heatmap page", value = 1,
             min = 1, max = 21, step = 1)
```

Column
-------------------------------------

### Heatmap 

```{r}
# Dynamic list for dropdown
output$choose_senator <- renderUI({
  
  sen_list <- nodes %>%
    filter(party %in% input$party)
  if (input$session2 == "113") {
    sen_list <- sen_list %>% filter(in_113 == 1)
  } else if (input$session2 == "114") {
    sen_list <- sen_list %>% filter(in_114 == 1)
  } else if (input$session2 == "115") {
    sen_list <- sen_list %>% filter(in_115 == 1)
  } 
  selectInput(inputId = "matrix_senator",
            label = "Sort by Senator",
            choices = sort(sen_list$label))
})

data_heatmap <- reactive({
  # Matrix filtering
  filtered <- subject_matrix %>%
    filter(party %in% input$party)

  if (input$session2 == "113") {
    filtered <- filtered %>% filter(in_113 == 1)
  } else if (input$session2 == "114") {
    filtered <- filtered %>% filter(in_114 == 1)
  } else if (input$session2 == "115") {
    filtered <- filtered %>% filter(in_115 == 1)
  }
  
  mat <- filtered %>% 
    select(-bioguideId, -label, -party, -in_113, -in_114, -in_115)
  rownames(mat) <- filtered$label
  
  # Compute distances
  dists <- distances(mat)
  
  # Output options
  n <- input$matrix_page
  rows <- min(nrow(mat), input$matrix_rows)
  
  # Matrix sorting
  sortby <- mat[input$matrix_senator, ]
  mat <- mat[, order(sortby, decreasing = TRUE)]
  #mat <- mat[order(mat[1], decreasing = TRUE), ]
  mat <- mat[nearest_neighbor_search(dists, rows, which(rownames(mat) == input$matrix_senator)), ]
  
  # To display
  mat[1:rows, (50 * (n - 1) + 1):(50 * n)]
})

renderPlotly({
  heatmaply(
    data_heatmap(),
    dendrogram = "none",
    label_names = c("Senator", "Subject", "Bills"),
    grid_gap = 0.3,
    hide_colorbar = TRUE
    )
})

```

<!-- Column {data-width=300} -->
<!-- ------------------------------------ -->

<!-- ### Network -->

<!-- ```{r, eval = FALSE} -->
<!-- edges <- reactive({ -->
<!--   simp_edges %>% -->
<!--     arrange(desc(weight)) %>% -->
<!--     filter(weight > quantile(weight, input$edge_filter)) -->
<!-- }) -->

<!-- #filter(from %in% head(nodes_subset()$bioguideId, 10) | to %in% head(nodes_subset()$bioguideId, 10)) %>% -->

<!-- renderForceNetwork({ -->
<!--   n <- nodes_subset() -->
<!--   e <- simp_edges %>% -->
<!--     filter(from %in% n$bioguideId | to %in% n$bioguideId) %>% -->
<!--     mutate(source = match(from, n$bioguideId) - 1, -->
<!--            target = match(to, n$bioguideId) - 1) -->

<!--   forceNetwork(Links = e, Nodes = n, -->
<!--              Source = "source", Target = "target", -->
<!--              Value = "weight", NodeID = "label", Group = "party", -->

<!--              # -- Nodes and labels -->
<!--              fontSize = 15, -->
<!--              fontFamily = "sans-serif", -->
<!--              opacity = 0.6, -->
<!--              opacityNoHover = 0.5, -->

<!--              # -- Edges -->
<!--              arrows = TRUE, -->
<!--              linkColour = c("grey", "grey"), -->

<!--              # -- Layout -->
<!--              linkDistance = 100, -->
<!--              charge = -30, -->

<!--              # -- General params -->
<!--              colourScale = JS('d3.scaleOrdinal().range(["green", "blue", "red"]).domain(function(d) { (d.party); });'), -->
<!--              zoom = TRUE, -->
<!--              bounded = TRUE -->
<!--              ) -->
<!-- }) -->
<!-- ``` -->

<!-- ### Other -->


Senator Activity {data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

### Select a legislative session and a state to get a close-up of each senator's focus areas. 

```{r}
### Inputs
radioButtons(inputId = "session3",
            label = "Select legislative session",
            choices = c("All"="*",
                        "113th Session" = "113",
                        "114th Session" = "114",
                        "115th Session" = "115"),
            selected = "113")

```


```{r}
#state Input
selectInput(inputId = "state3", 
            label = "Select a state", 
            choices = c("All" = "*", state.name),
            selected = "Alaska",
            selectize = FALSE)
```

Row {data-height=300}
-------------------------------------
### Senator Spotlight: Alaska (D)

The Senators from Alaska sponsor more bills than any other state. Looking more closely at Senator ___, who worked in the 113th and 114th session, However, as seen above, the top focus areas are 1) 2) and 3) and. Yet, the percentage of success for getting these bills passed is almost zero. Yadda Yadda Yadda. 

Row {data-width=600, data-height=400}
-------------------------------------
### Senator summary statistics 

```{r}

senatorstats <- reactive({
  senatordata %>% 
    filter(grepl(input$session3, session)) %>% 
    group_by(state, senator) %>% 
    filter(grepl(input$state3, state_name))
  })


renderTable({ 
  senatorstats() %>%
  summarise(sum(n()), 
           sum(billoutcome == "Became Law"), 
           Percent = mean(billoutcome == "Became Law")*100) %>%
  `colnames<-`(c("State", "Senator", "Bills Introduced", "Number Passed as Law", "% Passed as Law"))
  })
    

```


Column {data-height=700}
-------------------------------------

### Senator picture
```{r}
# ^^^ TEMPORARILY SET eval=FALSE ABOVE ^^^
#senator picture code here
#photo <- reactive({
 # senatordata %>% 
  #  filter(grepl(input$session3, session)) %>% 
   # group_by(state, senator) %>% 
  #  filter(grepl(input$state3, state_name)) %>% select(senator, image)
#  })

#renderText({ 
  
#   photo() %>% unique(photo())  %>%
 # group_by(senator) 
  
#  senatordata %>% 
 #   filter(grepl(input$session3, session)) %>% 
  #  group_by(state, senator) %>% 
   # filter(grepl(input$state3, state_name)) %>%
    # c('<img src="',
     #  "image",
      # '">')

photo <-
  senatordata %>% 
    filter(session == "113") %>% 
    group_by(state, senator) %>% 
    filter(state_name == "Alaska") %>% select(image)


photo2 <- unique(photo)
photo3 <- photo2$image
  
photo2$image <- paste0("<a href='",photo2$image,"'>",photo2$image,"</a>")

#  })
  renderUI({

#for (i in photo3){
#src = i
 # print(paste(tag = tags$img(src=src)))
   
src = 'https://www.congress.gov/img/member/m001153.jpg'
tags$img(src=src)

  })

```


### Senator Network Data

```{r}

network <- reactive({
  senatordata %>% 
    filter(grepl(input$session3, session)) %>% 
    group_by(state, senator) %>% 
    filter(grepl(input$state3, state_name))
  })

renderForceNetwork({ 
  # sen_ID0 <- senatorstats() 
  # test <- senatordata %>% filter(grepl(input$session3, session))
  # sen_ID <- test %>% filter(grepl(input$state3, state_name))
  # sen_ID <- unique(as.character(sen_ID$bioguideId))
  sen_ID <- network()$bioguideId
  
  senator_edges <- simp_edges %>% 
    filter((from == sen_ID | to == sen_ID))
  
  senator_edges <- senator_edges[order(senator_edges$weight,decreasing = TRUE)[1:20],]
  # Then subset nodes
  nodes_subset <- nodes %>%
    filter((bioguideId %in% senator_edges$to | bioguideId %in% senator_edges$from))
  
  # Set target and source as indices to node data
  # minus 1 because it converts to JS which uses 0-indexing
  senator_edges <- senator_edges %>%
    mutate(source = match(from, nodes_subset$bioguideId) - 1,
           target = match(to, nodes_subset$bioguideId) - 1)
          
  forceNetwork(Links = senator_edges, Nodes = nodes_subset,
       Source = "source", Target = "target",
       Value = "weight", NodeID = "label", Group = "party",
  
       # -- Nodes and labels
       fontSize = 15,
       fontFamily = "sans-serif",
       opacity = 0.6,
       opacityNoHover = 0.5,
  
       # -- Edges
       arrows = TRUE,
       linkColour = c("grey", "grey"),
  
       # -- Layout
       linkDistance = 100,
       charge = -30,
  
       # -- General params
       colourScale = JS('d3.scaleOrdinal().range(["green", "blue", "red"]).domain(function(d) { (d.party); });'),
       zoom = TRUE,
       bounded = TRUE
       )     
 })

```

### Senator picture 2
```{r}
renderUI({

#for (i in photo3){
#src = i
 # print(paste(tag = tags$img(src=src)))
   
src = 'https://www.congress.gov/img/member/b001265.jpg'
tags$img(src=src)

  })


```




Row {data-height=700}
-------------------------------------
### Top Policy Areas

```{r}
toppolicy <- reactive({
  senatordata %>% 
    filter(grepl(input$session3, session)) %>% 
          group_by(state,senator,policy_area) %>% filter(grepl(input$state3, state_name)) %>% 
          mutate(numspon = sum(n())) %>% select(state, senator, policy_area, numspon)
  })

renderTable({ 

test2  <-  toppolicy()
test2 <- unique(test2)  %>%
  group_by(senator) %>% filter(numspon > 1) %>%
  top_n(n = 5, wt = numspon) %>% 'colnames<-'(c("State", "Senator", "Policy Area", "Number Sponsored"))
  test2
 })

```

Bill Exploration {data-orientation=rows}
=====================================

Row {data-height=400}
-------------------------------------
### Explore Bills

Thousands of bills are sponsored and introduced into the Senate during each legislative session. 

There are many final statuses of a bill, but we will only focus on the main 6 here. They include:

  1. Introduced into Senate
  2. Ordered Reported
  3. Failed legislation; or received a vote, but failed in the senate
  4. Passed in the Senate 
  5. Passed in the House, but Vetoed by the President
  6. Became a law
  
Explore below to see how many bills get to each step of the process, and which types of bills tend to be those most likely to become a law.

  (need to add) Define: Policy Area or Legislative Subject, in contract

(Additionally) Which legislative subjects do most of the Senate bills focus on? Explore the types of policy areas that are most prevalently introduced as bills. 

